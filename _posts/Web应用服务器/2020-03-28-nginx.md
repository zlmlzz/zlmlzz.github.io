---
layout: post
title: Nginx
category: Web应用服务器
tags: nginx
keywords: Web引用服务器,nginx
---
Nginx是一个高性能的HTTP和反向代理web服务器,同时也提供IMAP/POP3/SMTP服务   
正向代理:
* 客户端请求目标服务器之间的一个代理服务器
* 请求会先经过代理服务器，然后再转发请求到目标服务器，获得内容后最后响应给客户端

反向代理:
* 用户请求目标服务器，由代理服务器决定访问哪个IP

## 安装nginx
1. 安装gcc环境 ``` yum install gcc-c++ ```
2. 安装pcre库，用于解析正则表达式 ``` yum install -y pcre pcre-devel ```
3. zlib 压缩和解压缩依赖 ``` yum install -y zlib zlib--devel ```
4. SSL安全的加密的套接字协议层，用于HTTP安全传输,即HTTPS
```
yum install -y openssl openssl-devel
```
5. 解压 ```tar -zxvf nginx ```
6. 配置 
```
./configure \
--prefix=/usr/local/nginx \
--pid-path=/var/run/nginx/nginx.pid \
--lock-path=/var/lock/nginx.lock \
--error-log-path=/var/log/nginx/error.log \
--http-log-path=/var/log/nginx/access.log \
--with-http_gzip_static_module \
--http-client-body-temp-path=/var/temp/nginx/client \
--http-proxy-temp-path=/var/temp/nginx/proxy \
--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \
--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \
--http-scgi-temp-path=/var/temp/nginx/scgi
```
7. 编译 ``` make ```
8. 安装 ``` make install ```
9. 启动停止重新加载命令
    * ``` ./nginx ```
    * ``` ./nginx -s stop```
    * ``` ./nginx -s reload```

## nginx.conf
配置结构:
* main 全局配置
* event 配置工作模式及连接数
* http http模块相关配置
    * server 虚拟主机配置，可以有多个
        * location 路由规则，表达式
    * upstream 集群，内网服务器

核心配置:
1. 设置worker进程的用户，指的是Linux中的用户，会涉及到nginx操作目录或文件的一些权限.默认为nobody ``` user nobody; ```
2. worker进程工作数设置，一般来说CPU有几个就设置几个，或者设置为N-1 ``` worker_processess 1; ```
3. nginx日志级别 ``` debug|info|notice|warn|error|crit|alert|emerg ```错误级别从左到右越来越大
4. 设置nginx进程pid ``` pid     logs/nginx.pid; ```
5. 设置工作模式 
```
events {
    # 默认使用epoll
    use epoll;
    # 每个worker允许连接的客户端最大连接数
    worker_connections 10240;
}
```
6. http是指令块，针对http网络传输的一些指令配置
```
http {
}
```
7. include引入外部配置，提高可读性，避免单个文件过大 ``` include mime.types; ```   
8. 设定日志格式，main为定义的格式名称，如此access_log就可以直接使用这个变量了   
9. `sendfile`使用高效文件传输，提升传输性能。启用后才能使用```tcp_nopush```,是指当数据表积累到一定大小后才发送，提高了效率
```
sendfile on;
tcp_nopush on;
```
10. `keepalive_timeout`设置客户端与服务端请求的超时时间，保证客户端多次请求的时候不会重复建立新的连接，节约资源损耗
```
# keepalive_timeout 0;
keepalive_timeout 65;
```

|参数名| |参数意义|
| :- | -:|  :-   |
|$remote_addr|:|客户端ip|
|$remote_user|:|远程客户端用户名，一般为:'-'|
|$time_local|:|时间和时区|
|$request|:|请求的url以及method|
|$status|:|响应状态码|
|$body_bytes_send|:|响应客户端字节数|
|$http_referer|:|记录用户从哪个链接跳转过来的|
|$http_user_agent|:|用户所使用的代理，一般来时都是浏览器|
|$http_x_forwarded_for|:|通过代理服务器来记录客户端的ip|   


## Nginx负载均衡配置、常用策略、场景及特点
* 轮询(默认)
    * 优点:实现简单
    * 缺点:不考虑每台服务器处理能力
* 权重
    * 优点:考虑了每台服务器处理能力的不同
* ip hash
    * 优点:能实现同一个用户访问同一个服务器
    * 缺点:根据ip hash不一定平均
    * z备注:不能把后台服务器直接移除，只能标记down
* url hash(第三方)
    * 优点:能实现同一个服务访问同一个服务器
    * 缺点:根据url hash分配请求会不平均,请求频繁的url会请求到同一个服务器上
* fair(第三方)
    * 特点:按后端服务器的响应时间来分配请求,响应时间短的优先分配   

## 负载均衡配置参数
upstream指令参数
* `max_conns`限制每台service的连接数，用于保护避免过载，可起到限流作用，默认值为0，即不限制连接数
* `slow_start`(商业版，需要付费)该参数不能使用在```hash```和```random load balancing```中。如果在upstream中只有一台server，则该参数失效
* `down`用于标记服务节点不可用
* `backup`表示当前服务器是备用机，只有在其他的服务器宕机以后，自己才会加入到集群中(```backup```参数不能使用在```hash```和```random load balancing```中)
* `max_fails`最大失败次数，满足条件则标记server已宕机，剔出上游服务(默认值为1)
* `fail_timeout`表示失败重试时间(默认值10秒)
* `keepalived`设置长连接处理的数量，提高吞吐量(```proxy_http_version```设置长连接http版本为1.1;```proxy_set_header```清除connection header信息)
* `leat_conn`请求连接最少的服务

```
upstream backserver{
    ip_hash;
    server 127.0.0.1:9090 down;(down 表示当前的server暂时不参与负载)
    server 127.0.0.1:8080 weight=2;(weight默认为1,weight越大,负载的权重就越大)
    server 127.0.0.1:6060;
    server 127.0.0.1:7070 backup;(其它所有的非backup机器down或者忙的时候,请求backup机器)
}
```
## Nginx缓存
1. 浏览器缓存
    * 加速用户访问，提升单个用户体验，缓存在本地
2. nginx缓存
    * 缓存在nginx端，提升所有访问到nginx端的用户
    ```
    # proxy_cache_path 设置缓存目录
    #       keys_zone  设置共享内存以及占用空间大小
    #       max_size   设置缓存大小
    #       inactive   超过此时间则被清理
    #       use_temp_path 临时目录，使用后会影响nginx性能
    location / {
        proxy_pass http://home;
        # 启用缓存和keys_zone一致
        proxy_cache mycache;
        # 针对200和304状态码缓存时间为8小时
        proxy_cache_valid 200 304 8h;
    }
    ```
    * 提升访问上游(upstream)服务器的速度
    * 用户访问仍然会产生请求流量
    * 控制浏览器缓存:
    ```
    location /files {
        alias /home;
        # expires 10s;
        # expires @22h30m;
        # expires -1h;
        # expires epoch;
        # expires off;
        expires max;
    }
    ```

## 使用Nginx配置HTTPS域名证书
1. 安装SSL模块(--with-http_ssl_mould)
2. 配置HTTPS
    * 把ssl证书```*.crt```和私钥```*.key```拷贝到nginx配置目录下
    * 新增server监听443端口
    ```
    server {
        listen 443;
        # 开启ssl
        ssl on;
        # 配置ssl证书
        ssl_certificate [证书路径];
        # 配置s证书密钥
        ssl_certificate_key [证书密钥路径];
        # ssl会话cache
        ssl_session_cache shared:SSL:1m;
        # ssl会话超时时间
        ssl_session_timeout 5m;
        # 配置加密套件，写法遵循openssl标准
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;
    }
    ```

## Nginx常用命令
* ` ./nginx -s stop`暴力关闭，推荐使用 ``` ./nginx -s quit ```关闭nginx
* ` ./nginx -t`检测配置文件是否正确
* ` ./nginx -c nginx.conf`指定配置文件启动

