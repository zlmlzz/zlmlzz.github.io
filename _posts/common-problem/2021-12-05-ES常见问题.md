---
layout: post
title: ES常见问题
category: FAQ
keywords: ES
---
## 常见问题
### 设计注意事项
* 根据业务量需求,采取基于日期模板创建索引,通过roll over api滚动索引
* 使用别名进行索引管理
* 定期对索引做force_merge操作,以释放空间
* 采取冷热分离,热数据存储到SSD,提高检索效率;冷数据定期shrink操作,以减少存储
* 仅针对需要分词的字段,合理的设置分词器
* mapping阶段充分结合各字段属性,是否需要检索,是否需要存储等

### 写入大量数据注意事项
* 写入前副本设置为0
* 写入前关闭`refresh_interval`设置为-1,禁用刷新机制
* 写入过程中采取bulk批量写入
* 写入后恢复副本数和刷新间隔
* 尽量使用自动生成的id

### 查询注意事项
* 禁用wildcard
* 禁用批量terms(成百上千)
* 利用索引倒排机制,能keyword类型尽量keyword
* 数据量大的时候,可以先基于时间敲定索引再检索
* 设置合理的路由机制

### es的倒排索引
### es是如何实现master选举的
* 前提:候选主节点(master:true)的节点才能成为主节点
* 先确认候选主节点(`discovery.zen.minimum_master_nodes`)数达标
* 比较:先判定是否具备master资格,具备候选主节点资格的优先返回;
* 若两节点都为候选主节点,则id小的值会主节点

### es索引文档的过程
* (单文档写入):
* 客户端写集群节点写入数据,发送请求(如果没有指定路由/协调节点,请求的节点扮演路由节点的角色)
* 节点1接受到请求后,使用文档_id来确定文档属于分片0,请求会被转到另外的节点3,因此分片0的主分片分配到节点3上
* 节点3在主分片上执行写操作,成功则将请求并行转发到节点1和节点2(副本分片)上
* 所有的副本分片都报告成功,节点3向节点1报告成功,节点1向客户端报告写入成功

### es搜索过程
* 假设一个索引的数据有5主+1副共10个分片,一次请求会命中(主或副)的一个
* 每个分片在本地进行查询,结果返回到本地有序的优先队列中
* 各个分片将结果发送到协调节点,协调节点产生一个全局的排序列表,路由节点获取所有文档,返回给客户

### es部署注意事项
* 关闭缓存swap
* 堆内存设置:min(节点内存/2,32GB)
* 设置最大文件句柄数
* 线程池和队列大小根据业务调整

### lucence内部结构
### es中的节点(如20个),其中10个选了一个master，另外10个选了另一个master,怎么处理
* 当集群节点master候选数量不小于3个时,可以通过设置最少投票通过数量`discovery.zen.minimum_master_nodes`超过所有候选节点一半以上来解决脑裂问题
* 当候选数量为2时，设置其中一个为master

### 客户端和集群连接时,如何选定特定的节点执行请求
### es更新和删除文档过程
* 删除和更新都是写操作,但是es中的文档是不可变的,因此不能被删除或者改动以展示其变更
* 磁盘上每个段都有一个相应的.del文件,当删除请求发送后,文档并没有真的被删除,而在.del文件中被标记为删除
* 该文档依然能匹配查询,但是会在结果中被过滤掉,当段合并时,在.del文件中被标记为删除的文档将不会被写入新段
* 在新的文档被创建时,es会为该文档指定一个版本号,当执行更新时,旧版本的文档在.del文件中被标记为删除,新版本的文档被索引到一个新的段,旧版本的文档依然能匹配查询,但是会在结果中被过滤掉

### es中怎么根据一个词找到对应的倒排索引
### GC方面,es使用中注意事项
* 倒排词典的索引需要常驻内存,无法GC,需要监控data node上segmentmemory增长趋势
* 避免返回大量结果集的搜索和聚合,如无法避免,可以采用scan和scroll来实现

### es对于大数据量(上亿量级)的聚合如何实现
* cardinality度量

### 并发情况下,es如何保证读写一致
* 可以通过版本号使用乐观锁并发控制,以确保新版本不会被旧版本覆盖,由应用层来处理具体的冲突
* 对于写操作,一致性级别支持quorum/one/all,默认为quorum,即只有当大多数分片可用时才允许写操作,如因网络等原因导致写入副本失败,这样的副本被认为故障,分片将会在一个不同的节点上重建
* 对于读操作,可以设置replication为sync(默认),这使得操作会在主分片和副本分片都完成后才会返回;如果设置replication为async时,也可以通过设置搜索请求参数_preference为primary来查询主分片,确保文档是最新版本

### 拼写纠错是如何实现的
* 基于编辑距离来实现的;编辑距离是一种标准的方法,它用来表示经过插入,删除和替换操作从一个字符串转换到另外一个字符串的最小操作步骤

### es中的属性enabled,index和store的功能是什么
* enabled:false,启用的设置仅可应用于顶级映射定义和object对象字段,es跳过对字段内容的解析;仍然可以从_source字段中检索json,但是无法搜索或以其他任何方式存储
* index:false,索引选项控制是否对字段值建立索引,默认为true,未索引的字段不可查询
* store:某些特殊场景下,如果只想检索单个字段或几个字段的值,而不是整个_source的值,则可以使用源过滤来实现

### es analyzer中的字符过滤器如何利用
* 字符过滤器将原始文本作为字符流接收,并可以通过添加,删除或更改字符来转换字符流
* html strip character filter:删除html元素,并解码html实体,如`&amp`
* mapping character filter:替换指定的字符串
* pattern character filter:基于正则表达式替换

### es NRT?
* 从文档索引(写入)到可搜索之间的延迟默认1秒,因此es是近实时(NRT)搜索平台

### es的filesystem
* es每次走filesystem cache查询速度是最快的,所以将每个查询的数据50%容量=filesystem cache容量

### es数据预热
* 每隔一段时间,将热数据手动在后台查询一遍,将热数据刷新到filesystem cache上

### es的document设计
* 使用es时避免使用复杂语句(join,聚合),应在建立索引时,根据查询语句建立好对应的元数据
