---
layout: post
title: MySQL
category: 数据库
tags: 监控,调优
keywords: 监控,调优
--- 
### 慢查询日志
* MySQL内置功能,可以记录执行超过指定时间的SQL语句
* 相关参数

```
log_output:日志输出地方,默认FILE(文件),设置TABLE(将日志记录到mysql.slow_log中)
    也可以同时设置,逗号隔开
long_query_time:执行时间超过该配置则记录,单位秒,可适用小数,默认10
log_queries_not_using_indexes:是否将未适用索引的SQL记录到慢查询日志中,默认OFF
log_throttle_queries_not_using_indexes:与log_queries_not_using_indexes配合使用
    限制每分钟写入的SQL数量,默认0
min_examined_row_limit:扫描行数至少达到多少记录才记录到慢查询日志,默认0
log_slow_admin_statements:是否记录管理语句,默认关闭
slow_query_log_file:指定慢查询日志文件路径,默认/var路径
log_slow_slave_statements:从数据库设置,决定是否记录在复制过程中超过long_query_time
    的SQL,如果binlog格式是row,则该参数无效,默认OFF
log_slow_extra:当log_output=FILE时,是否记录额外信息(8.0.14开始提供)
    对TABLE的结果无影响
```
* mysqldumpslow分析日志文件

### SQL性能分析
* EXPLAIN
    * id
    * select_type:查询类型
    * table:表名
    * partitions:匹配的分区
    * type:联接类型
    * possible_keys:可能的索引选择
    * key:实际选择的索引
    * key_len:索引的长度
    * ref:被引用的索引列
    * rows:估计要扫描的行
    * filtered:符合查询条件的数据百分比
    * extra:附加信息
    * 估算查询性能:`log(row_count)/log(index_block_lenght / 3 * 2 / (index_length + data_pointer_length)) + 1`
* SHOW PROFILE(简单方便,已废弃)

```
## 查看有无profile
select @@have_profiling;
select @@profiling;
## 启用
set @@profiling = 1;
set profiling_history_size = 100;
## 查看并找到id136
show profiles ;
show profile for query 136;
## 关闭
set @@profiling = 0;
```
* INFORMATION_SCHEMA_PROFILING(与profile本质一样)

```
select @@have_profiling;
select @@profiling;
set @@profiling = 1;
set profiling_history_size = 100;
show profiles ;
select state,format(duration,6) as duration 
from information_schema.PROFILING where QUERY_ID = 261 order by SEQ;
```
* PERFOMANCE_SCHEMA

```
## 设置
update performance_schema.setup_instruments
set enabled = 'YES',timed = 'YES'
where name like '%statement/%';

update performance_schema.setup_instruments
set enabled = 'YES',timed = 'YES'
where name like '%stage/%';

update performance_schema.setup_consumers
set enabled = 'YES'
where name like '%events_statements_%';

update performance_schema.setup_consumers
set enabled = 'YES'
where name like '%events_stage%';
## 查询并找到id1164
select event_id,truncate(timer_wait/1000000000000,6) as duration,sql_text
from performance_schema.events_statements_history_long 
where sql_text like '%salaries%';
## 具体信息
select event_name as stage,truncate(timer_wait/1000000000000,6) as duration
from performance_schema.events_stages_history_long 
where nesting_event_id = 1164;
```
* OPTIMIZER_TRACE

```
## 开启OPTIMIZER_TRACE功能
set optimizer_trace = 'enabled=on',end_markers_in_json=on;
## 设置要展示的条数
set optimizer_trace_offset = -30,optimizer_trace_limit =30;
## 查询
select * from information_schema.OPTIMIZER_TRACE limit 30;
```

### 常用诊断命令
* SHOW PROCESSLIST(查看当前正在运行的线程)
* SHOW STATUS(查看服务器相关信息)
* SHOW VARIABLES(查看变量)
* SHOW TABLE STATUS(查看表及视图状态)
* SHOW INDEX(查看索引信息)
* SHOW ENGINE(展示有关存储引擎的相关信息)
* SHOW MASTER STATUS(展示有关master binlog文件的相关信息)
* SHOW SLAVE STATUS(查看slave线程)

### 索引
* B+Tree
* Hash
* 空间索引(R-Tree)
* 全文索引
